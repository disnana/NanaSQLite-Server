name: Security Scan

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  schedule:
    # æ¯Žé€±æœˆæ›œ 9:00 JST (0:00 UTC)
    - cron: '0 0 * * 1'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # CodeQL - ã‚³ãƒ¼ãƒ‰ã®è„†å¼±æ€§é™çš„è§£æž
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: python
        queries: security-and-quality
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:python"

  # Safety - Pythonä¾å­˜é–¢ä¿‚ã®æ—¢çŸ¥è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
  safety:
    name: Safety Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety pip-audit
        pip install -e .
    
    - name: Run Safety check
      run: safety check --full-report || true
      continue-on-error: true
    
    - name: Run pip-audit
      run: pip-audit --progress-spinner=off

  # Bandit - Pythonã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é™çš„è§£æž
  bandit:
    name: Bandit Security Linter
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
    
    - name: Install Bandit
      run: pip install bandit[toml]
    
    - name: Run Bandit
      run: bandit -r src/ -f json -o bandit-report.json || true
    
    - name: Upload Bandit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-report
        path: bandit-report.json

  # Trivy - åŒ…æ‹¬çš„ãªè„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
  trivy:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
    
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒžãƒªãƒ¼
  summary:
    name: Security Summary
    needs: [codeql, safety, bandit, trivy, grype]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Create summary
      run: |
        echo "## ðŸ›¡ï¸ Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CodeQL | ${{ needs.codeql.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Safety | ${{ needs.safety.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Bandit | ${{ needs.bandit.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Trivy | ${{ needs.trivy.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Grype | ${{ needs.grype.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check logs' }} |" >> $GITHUB_STEP_SUMMARY

    - name: Verify all checks passed
      if: always()
      run: |
        echo ""
        echo "ðŸ“ Job statuses:"
        echo "ðŸ“ codeql â†’ ${{ needs.codeql.result == 'success' && 'âœ“ success' || format('âœ— {0}', needs.codeql.result) }} [required]"
        echo "ðŸ“ safety â†’ ${{ needs.safety.result == 'success' && 'âœ“ success' || format('âœ— {0}', needs.safety.result) }} [required]"
        echo "ðŸ“ bandit â†’ ${{ needs.bandit.result == 'success' && 'âœ“ success' || format('âœ— {0}', needs.bandit.result) }} [required]"
        echo "ðŸ“ trivy â†’ ${{ needs.trivy.result == 'success' && 'âœ“ success' || format('âœ— {0}', needs.trivy.result) }} [required]"
        echo "ðŸ“ grype â†’ ${{ needs.grype.result == 'success' && 'âœ“ success' || format('âœ— {0}', needs.grype.result) }} [required]"
        echo ""
        
        # Check for failures
        FAILED=false
        if [[ "${{ needs.codeql.result }}" != "success" ]]; then FAILED=true; fi
        if [[ "${{ needs.safety.result }}" != "success" ]]; then FAILED=true; fi
        if [[ "${{ needs.bandit.result }}" != "success" ]]; then FAILED=true; fi
        if [[ "${{ needs.trivy.result }}" != "success" ]]; then FAILED=true; fi
        if [[ "${{ needs.grype.result }}" != "success" ]]; then FAILED=true; fi
        
        if [ "$FAILED" = true ]; then
          echo "âŒ One or more security checks failed."
          exit 1
        else
          echo "# âœ“ All security checks succeeded ðŸŽ‰ðŸŽ‰ðŸŽ‰"
        fi

  # Grype - è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ (OS/Python/JS)
  grype:
    name: Grype Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Scan for vulnerabilities
      uses: anchore/scan-action@v7
      with:
        path: "."
        fail-build: false # ãƒ¬ãƒãƒ¼ãƒˆé›†ç´„ã®ãŸã‚ã€ã“ã“ã§ã¯è½ã¨ã•ãªã„ï¼ˆå¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§åˆ¤å®šï¼‰
        output-format: json
    
    - name: Upload Grype report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: grype-results
        path: results.json

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆé›†ç´„
  security-report:
    name: Generate Security Report
    needs: [codeql, safety, bandit, trivy, grype]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v7
      with:
        path: artifacts

    - name: Generate Detailed Report
      run: |
        echo "# ðŸ›¡ï¸ Comprehensive Security Report" > security-report.md
        echo "Generated at: $(date -u)" >> security-report.md
        echo "" >> security-report.md
        
        echo "## ðŸ” Detailed Findings" >> security-report.md
        echo "*(If any issues are found, they will be listed below)*" >> security-report.md
        echo "" >> security-report.md
        
        # Grype Findings
        if [ -f artifacts/grype-results/results.json ] && jq -e '.matches | length > 0' artifacts/grype-results/results.json > /dev/null; then
            echo "### ðŸ“¦ Grype Scan Results" >> security-report.md
            # JSONè§£æžã—ã¦Markdownã«å¤‰æ› (ç°¡æ˜“çš„ãªjqå‡¦ç†)
            echo "\`\`\`json" >> security-report.md
            jq -r '.matches[] | "Title: " + .vulnerability.id + "\nPackage: " + .artifact.name + " (" + .artifact.version + ")\nSeverity: " + .vulnerability.severity + "\nLink: " + .vulnerability.dataSource + "\n---"' artifacts/grype-results/results.json | head -n 50 >> security-report.md || echo "Parse error" >> security-report.md
            echo "\`\`\`" >> security-report.md
        fi

        # Bandit Findings
        if [ -f artifacts/bandit-report/bandit-report.json ] && jq -e '.results | length > 0' artifacts/bandit-report/bandit-report.json > /dev/null; then
            echo "### ðŸ Bandit Scan Results" >> security-report.md
            echo "\`\`\`json" >> security-report.md
            jq -r '.results[] | "Issue: " + .issue_text + "\nSeverity: " + .issue_severity + "\nFile: " + .filename + ":" + (.line_number|tostring) + "\n---"' artifacts/bandit-report/bandit-report.json | head -n 50 >> security-report.md || echo "Parse error" >> security-report.md
            echo "\`\`\`" >> security-report.md
        fi

        cat security-report.md >> $GITHUB_STEP_SUMMARY

    - name: Upload Full Report
      uses: actions/upload-artifact@v4
      with:
        name: full-security-report
        path: security-report.md
