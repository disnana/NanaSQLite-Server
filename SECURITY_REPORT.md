# NanaSQLite-Server セキュリティ調査報告書

## 1. エグゼクティブサマリー
NanaSQLite-Server v1.0.1dev1 (NanaSQLite v1.3.2対応) に対するセキュリティ調査を実施しました。
調査の結果、認証済みユーザーによる任意のSQL実行が可能な深刻な脆弱性や、サーバーを停止させる可能性のある複数のサービス拒否（DoS）脆弱性が特定されました。

現在の実装は「ブラックリスト方式」で許可メソッドを制限していますが、制限が不十分であり、基盤となる NanaSQLite ライブラリの強力な機能を制御できていません。また、リソース管理においても不備が見られ、悪意のあるクライアントによってサーバーメモリを容易に枯渇させることが可能です。

## 2. 脆弱性一覧
| ID | 脆弱性名 | 深刻度 | CVSS v3 (推定) |
|:---|:---|:---|:---|
| VULN-001 | 許可メソッドの不備による任意SQL実行およびデータ破壊 | **CRITICAL** | 9.9 (CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H) |
| VULN-002 | 巨大なレスポンス生成によるメモリ枯渇 (DoS) | **MEDIUM** | 6.5 (CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H) |
| VULN-003 | 複数ストリームのバッファリングによるメモリ枯渇 (DoS) | **HIGH** | 7.5 (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H) |
| VULN-004 | BANメカニズムの不備とIPアドレス識別の曖昧さ | **LOW** | 3.5 (CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:L) |

---

## 3. 脆弱性の詳細

### 3.1 [VULN-001] 許可メソッドの不備による任意SQL実行およびデータ破壊
- **詳細**: `server.py` の `FORBIDDEN_METHODS`（ブラックリスト）に `fetch_all`, `fetch_one`, `drop_table`, `clear`, `create_table` 等の危険なメソッドが含まれていません。
- **影響**: 認証されたユーザーは、`fetch_all` を介して任意のSQL（`DROP TABLE`, `INSERT`, `DELETE`等）を実行でき、データベースの完全な制御を奪取可能です。また、直接 `drop_table` や `clear` を呼び出して全データを削除することも可能です。
- **再現PoC**: `poc_vulnerabilities/poc_sql_injection.py`

### 3.2 [VULN-002] 巨大なレスポンス生成によるメモリ枯渇 (DoS)
- **詳細**: サーバーはクライアントへのレスポンスをシリアライズする際、サイズ制限を設けていません。
- **影響**: `items()` や `keys()` のように大量のデータを返すメソッドを呼び出すことで、サーバー側で巨大なバイト列が生成され、メモリを大量に消費します。これにより、OSのOOM Killerによってサーバープロセスが強制終了される可能性があります。
- **再現PoC**: `poc_vulnerabilities/poc_dos_memory.py`

### 3.3 [VULN-003] 複数ストリームのバッファリングによるメモリ枯渇 (DoS)
- **詳細**: 単一ストリームのバッファサイズは10MBに制限されていますが、ストリームの「総数」に対する制限がありません。
- **影響**: 攻撃者が数千のQUICストリームを開き、それぞれで制限ぎりぎりのデータを送る（かつ終了させない）ことで、サーバーの `stream_buffers` 辞書が肥大化し、メモリを枯渇させます。これは未認証の状態でも実行可能です。
- **再現PoC**: `poc_vulnerabilities/poc_dos_streams.py`

### 3.4 [VULN-004] BANメカニズムの不備とIPアドレス識別の曖昧さ
- **詳細**: IPアドレスの取得に失敗した場合に 'unknown' として扱う実装になっており、共有環境では誤検知が発生します。また、`failed_attempts` リストが上限に達した際に `clear()` されるため、継続的な攻撃によって既存のBANリストが消失します。
- **影響**: 正規のユーザーが攻撃者の巻き添えでBANされたり（巻き添え被害）、攻撃者が大量のダミーリクエストを送ることでBANを回避したりすることが可能です。
- **再現PoC**: `poc_vulnerabilities/poc_ban_bypass.py`

---

## 4. 対策案と評価

### 案A: ホワイトリスト方式への移行 (推奨)
- **内容**: 実行可能なメソッドを `get_item_async`, `set_item_async` 等の安全なものに限定する。
- **メリット**: 未知の危険なメソッドや、ライブラリ更新で追加された新メソッドに対しても安全。
- **デメリット**: 柔軟性が低下し、新しい機能を利用する際にサーバー側の更新が必要。

### 案B: リソース制限の強化
- **内容**:
    1. レスポンス生成時にもサイズ制限を設ける。
    2. 接続ごとの合計バッファサイズ制限および同時ストリーム数の制限。
    3. `fetch_all` 等の汎用SQL実行メソッドの完全禁止（ブラックリストへの追加）。
- **メリット**: 現行の柔軟性を維持しやすい。
- **デメリット**: ブラックリストのメンテナンス漏れが発生するリスクが残る。

---

## 5. 結論
NanaSQLite-Serverは現在、認証済みユーザーに対して過剰な権限を与えており、かつリソース消費に対する防御が不十分です。
特に **VULN-001** は致命的であり、早急に実行可能なメソッドをホワイトリスト化するか、ブラックリストを大幅に拡充する必要があります。また、DoS対策として接続全体のクォータ制限を導入することを強く推奨します。
