# NanaSQLite-Server セキュリティ・信頼性調査報告書 (改訂版)

## 1. 調査の前提：Ed25519認証の堅牢性について
本調査にあたり、まず前提として**「Ed25519署名を用いたパスキー認証は現時点で事実上突破不可能であり、外部の攻撃者が未認証のままサーバー内に侵入することはできない」**という点を高く評価し、これを設計の根幹として認めます。

したがって、本報告書で挙げる「SQLインジェクション」や「データ破壊」のリスクは、**外部からの侵入を許す脆弱性ではなく、認証を通過した「正規の利用者」の安全を守るためのガードレールの欠如**として定義します。

## 2. リスクの再定義と多層防御の考え方
「侵入が不可能」であっても、以下の観点からシステム内部の制限（SQL制限など）は重要となります。
- **多層防御 (Defense in Depth)**: 認証（第一の壁）に全幅の信頼を置きつつ、万が一のクライアント側の鍵紛失や設定ミス、プログラムのバグといった「内部的な事故」が起きた際の被害を最小限に留める。
- **可用性の確保**: 意図しない巨大なクエリの発行によるサーバー自壊を防止する。

## 3. 調査結果一覧
| ID | 項目 | カテゴリ | 位置付け | 概要 |
|:---|:---|:---|:---|:---|
| REL-001 | 巨大レスポンスによるサーバーの自壊 | 可用性 | 運用事故防止 | 正規ユーザーが誤って全件取得等を行った際、サーバーがメモリ不足で停止する。 |
| REL-002 | SQL/メソッド制限の不備 | 信頼性 | 多層防御/安全対策 | `fetch_all` 等の制限漏れにより、正規ユーザー側の不注意でデータを全削除できる状態にある。 |
| DOS-001 | 認証前のリソース占有 | 可用性 (DoS) | 外部攻撃対策 | 鍵を持たない第三者が接続を占有し、正規ユーザーのアクセスを妨害できる。 |
| BUG-001 | リモート接続不能バグ | 機能 | 基本仕様 | 127.0.0.1に固定されており、リモートサーバーとして機能しない。 |

---

## 4. 詳細分析

### 4.1 [REL-002] 多層防御としてのメソッド制限の強化
- **分析**: 現在、`fetch_all` を介して任意のSQLが実行可能です。
- **理由（なぜ対策が必要か）**: 認証が強力であれば外部からは安全ですが、**「クライアント側のアプリケーションコードのバグ」**や**「開発時のヒューマンエラー」**により、意図せず `DROP TABLE` 等が発行されるリスクがあります。サーバー側でこれらを制限しておくことは、正規ユーザーのデータを誤操作から守るための「命綱」となります。

### 4.2 [DOS-001] 認証前リソース占有（外部からの妨害）
- **分析**: 認証そのものは突破できずとも、接続試行を繰り返すことでサーバーをビジー状態にできます。
- **理由**: 「侵入」は防げても「営業妨害（DoS）」は防げない状態です。正規ユーザーがいつでも安定して接続できる状態を保つために、接続管理の強化が必要です。

---

## 5. 結論
Ed25519による「門番」は極めて優秀であり、機密性は完全に守られています。
今後の改善の方向性は、その門番の内側にいる**正規ユーザーが「誤って自分たちのデータを壊さないための仕組み（安全装置）」**と、**門の外から嫌がらせをしてくる者への「門前払い（DoS対策）」**の強化にあると結論付けます。
