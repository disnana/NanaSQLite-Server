# NanaSQLite-Server セキュリティ対策・新機能報告書

## 1. 実施したセキュリティ対策
未認証の第三者によるサービス妨害（DoS攻撃）を防ぐため、以下のガードレールを実装しました。

### 1.1 未認証時のリソース制限 (Anti-DoS)
- **同時ストリーム数の制限**: 認証前の1接続あたりの同時ストリーム数を最大50に制限しました。これにより、大量のストリームを開いてメモリを占有する攻撃を防止します。
- **合計バッファサイズの制限**: 1接続あたり合計50MBのバッファ上限を設定しました。
- **即時BANチェック**: 各リクエスト処理の直前にBAN状態を再確認することで、BANされた攻撃者からの通信を即座に遮断します。

## 2. 新機能：ユーザーベースの権限管理 (RBAC)
従来の「単一の公開鍵」による認証から、**「複数のアカウント」と「個別の権限設定」**が可能なシステムへ進化させました。

### 2.1 AccountManager の導入
- `accounts.json` ファイルにより、ユーザー名、公開鍵、および許可/禁止メソッドを柔軟に管理できます。
- 設定例:
  ```json
  {
      "name": "readonly_user",
      "public_key": "ssh-ed25519 ...",
      "allowed_methods": ["get_item_async", "list_tables"],
      "forbidden_methods": null
  }
  ```

### 2.2 即時反映メカニズム (Real-time Enforcement)
- **設定の動的再読み込み**: RPC実行のたびに `accounts.json` の更新日時を確認し、変更があれば即座にメモリ上の権限情報を更新します。
- **権限剥奪の即時反映**: サーバーの再起動なしに、特定のユーザーの権限を変更したり、アカウントを削除（無効化）したりすることが可能です。
- **メリット**: 緊急時の権限剥奪やBANが、確立済みのセッションに対しても次のリクエストから即座に適用されます。
- **最適化**: 頻繁なI/Oを避けるため、ファイルチェックには1秒のスロットルを導入し、軽量化を図っています。

### 2.3 CPU DoS 対策 (署名検証の最適化)
- **アカウントヒントの導入**: 認証時、クライアントが自身のアカウント名を提示できるようプロトコルを拡張しました。
- **効率的な検証**: サーバーは提示されたアカウントの公開鍵のみを検証するため、アカウント数が増加してもCPU負荷が一定に保たれます（ヒントがない場合は従来の線形探索を実行し、互換性を維持します）。

## 3. 検証結果
- **自動テストの導入**: `tests/test_rbac_dos.py` を追加し、以下の項目を自動的に検証できるようにしました。
    - アカウントごとの個別権限制限 (RBAC)
    - 権限・アカウント無効化の即時反映 (Real-time Policy Enforcement)
    - 未認証時の同時ストリーム数制限 (Anti-DoS)
    - 未認証時の合計バッファサイズ制限 (Anti-DoS)
- **PoC検証済**: `poc_rbac_realtime.py` や `poc_dos_streams.py` などの独立したPoCスクリプトによっても、対策が有効であることを実証済みです。

## 結論
今回のアップデートにより、未認証時の攻撃に対する堅牢性が向上しただけでなく、運用において不可欠な「きめ細やかな権限管理」と「即時レスポンス」を備えた、よりプロフェッショナルなサーバーへと進化しました。
