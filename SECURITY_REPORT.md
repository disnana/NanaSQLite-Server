# NanaSQLite-Server セキュリティ・信頼性調査報告書

## 1. 調査の背景と前提
本調査では、Ed25519パスキー認証による強力な防御を前提としつつ、サーバーの「可用性（サービスを継続できるか）」「信頼性（意図しない動作で自壊しないか）」および「潜在的な設計バグ」に焦点を当てて調査を実施しました。

## 2. 脆弱性・リスク一覧 (可用性・信頼性重視)
| ID | 項目 | カテゴリ | 深刻度 | 概要 |
|:---|:---|:---|:---|:---|
| REL-001 | 巨大レスポンスによるサーバーの自壊 | 可用性/信頼性 | **HIGH** | 正規ユーザーの操作でも、メモリ超過でサーバーが停止する。 |
| DOS-001 | 認証前のリソース占有によるサービス停止 | 可用性 (DoS) | **HIGH** | 鍵を持たない攻撃者がサーバーのメモリを枯渇させ、正規ユーザーを排除できる。 |
| DOS-002 | IP誤認による一括アクセス遮断 | 可用性 (DoS) | **MEDIUM** | 特定の環境で正規ユーザーが巻き添えでBANされる。 |
| BUG-001 | リモート接続不能バグ | 機能 | **LOW** | 127.0.0.1にバインドされているため、本来の用途（RPC）が制限されている。 |
| BUG-002 | 特定例外のハンドリング不足 | 機能 | **LOW** | `TypeError` 等が適切に処理されず、予期しないエラー応答になる。 |

---

## 3. 詳細分析

### 3.1 [REL-001] 正規操作によるサーバー自壊 (DoS via Large Result Set)
- **詳細**: `items()` や `keys()` など、DB全体をシリアライズして返すメソッドにおいて、データ量に対する制限がありません。
- **リスク**: 認証済みユーザー（管理者等）が大量のデータが含まれるDBを操作した際、サーバー側で巨大なメモリ消費が発生し、プロセスがクラッシュします。「不正侵入」がなくとも、通常の運用中にサーバーが突然死するリスクがあります。
- **再現PoC**: `poc_vulnerabilities/poc_dos_memory.py`

### 3.2 [DOS-001] 認証前リソース占有 (DoS via Multiple Streams)
- **詳細**: サーバーは接続確立後、認証が完了する前の段階でQUICストリームのバッファリングを行います。
- **リスク**: 鍵を持っていない（＝侵入できない）攻撃者であっても、大量の未完了ストリームを送りつけることでサーバーのメモリを使い果たさせ、正規のユーザーが接続できない状態を作ることができます。
- **再現PoC**: `poc_vulnerabilities/poc_dos_streams.py`

### 3.3 [BUG-001] ネットワーク設定の不備 (127.0.0.1 Bind)
- **詳細**: `server.py` の `main` 関数でホストが `127.0.0.1` に固定されています。
- **リスク**: このサーバーは「RemoteNanaSQLite」というリモート利用を想定したクライアントを提供していますが、現状の設定では外部のIPアドレスからの接続を一切受け付けません。本来の機能が損なわれている状態です。

---

## 4. 対策案

### 案1: 可用性ガードレールの導入 (推奨)
- **内容**: レスポンスの最大サイズ制限、および接続あたりの同時ストリーム上限を設定します。
- **効果**: 「認証は突破できない」という前提の上で、意図しない事故や嫌がらせによる「サーバー停止」を防止します。

### 案2: IP識別ロジックの改善
- **内容**: IPアドレスが取得できない場合に一律で 'unknown' とせず、接続を拒否するか、別の識別子（Connection ID等）を使用するように変更します。
- **効果**: 誤BANによる正規ユーザーの締め出しを防止します。

## 5. 結論
認証システムが強固であるため、データの盗難（機密性への攻撃）のリスクは極めて低いと言えます。しかし、**可用性（Availability）**については無防備な部分があり、外部からの嫌がらせや正規ユーザーのミスによってサービスが停止する可能性が残されています。
これらのバグ・リスクを修正することで、より堅牢で信頼性の高いシステムになると評価します。
