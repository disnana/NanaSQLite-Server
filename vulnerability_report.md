# 脆弱性調査・リスク分析報告書およびテスト改善提案

## 1. 脆弱性の調査結果 (PoC実証済み)

現状の `nanasqlite-server` において、以下の脆弱性とセキュリティ上の懸念事項を特定しました。

### 1.1 破壊的なメソッド呼び出しによる認可バイパス (重要度: 高)
- **内容**: サーバー側の `FORBIDDEN_METHODS` (ブラックリスト) に、データベースの構造を変更したり全データを削除したりできるメソッドが含まれていません。
- **実証**: 認証済みのユーザーであれば、`drop_table`, `clear`, `batch_delete`, `import_from_dict_list` 等をRPC経由で実行可能であることを確認しました。
- **影響**: 悪意のあるユーザーがデータベース全体を破壊、または機密データを一括削除できる可能性があります。
- **修正案**: `FORBIDDEN_METHODS` に破壊的なメソッドをすべて追加するか、逆に許可するメソッドのみを定義する「ホワイトリスト方式」への変更を強く推奨します。

### 1.2 共有DBインスタンスのスレッドセーフティ (重要度: 中)
- **内容**: 全ての接続で単一の `NanaSQLite` インスタンス (`_shared_db`) を共有し、`ThreadPoolExecutor` で操作を実行しています。
- **懸念**: `nanasqlite` (内部で `apsw` を使用) はスレッドセーフなモードで構成されている必要がありますが、共有インスタンスに対して複数のスレッドから同時に書き込みを行う際の一貫性や競合状態について、明示的なロック制御が見当たりません。
- **影響**: 高負荷時にデータベースの破損や、予期しない例外によるサーバー停止が発生する可能性があります。

### 1.3 BAN機能の論理的欠陥によるDoSの可能性 (重要度: 低)
- **内容**: `failed_attempts` 辞書が `MAX_BAN_LIST_SIZE` を超えた際、辞書全体を `clear()` するロジックになっています。
- **影響**: 攻撃者が大量の異なるIPから不当なアクセスを試みることで、他の正当なユーザーの（誤入力等による）失敗カウントまでリセットされる可能性があります。また、BANリスト自体のメモリ制限が10,000件となっており、メモリ消費量に対する厳密な制限としては不十分な場合があります。

---

## 2. 潜在的リスクとバグ・欠陥

### 2.1 型チェックの不足
- 認証後のRPC実行 (`execute_rpc`) において、受け取ったメッセージが `dict` 型であることのチェックはされていますが、`args` が `list`、`kwargs` が `dict` であることの厳密な検証が不足しています。

### 2.2 リソース管理
- QUICストリームごとに10MBのバッファを確保しますが、コネクションあたりの最大ストリーム数や、サーバー全体での合計バッファ使用量に対する制限がありません。これにより、多数の接続を維持することでメモリを枯渇させることが可能です。

---

## 3. pytestを網羅的かつ確実にするための提案

現在のテストスイートを強化し、本番環境に耐えうる信頼性を確保するための提案です。

### 3.1 異常系・境界値テストの拡充
以下のテストケースの追加を推奨します：
- **極端な入力**: 巨大な文字列、深いネストを持つリスト/辞書、不正なバイナリデータの送信。
- **同時接続負荷**: 100以上の同時接続からの同時読み書き。
- **タイムアウト**: ネットワーク遅延や処理遅延が発生した際のリトライとタイムアウトの挙動。

### 3.2 セキュリティテストの自動化
PoCで実施した内容を、通常のCIに組み込むべきです：
- `FORBIDDEN_METHODS` にある全てのメソッドが正しく拒否されることの検証。
- 認証トークン（チャレンジ）の再利用防止の検証。

### 3.3 テストインフラの改善
- **pytest-asyncio の活用**: 非同期通信のテストをより洗練させ、`event_loop` の寿命管理を適切に行います。
- **カバレッジ測定 (`pytest-cov`)**: コード網羅率を常に監視し、特にエラーハンドリングパスがテストされているか確認します。
- **マルチプロセス実行 (`pytest-xdist`)**: 大規模な結合テストを高速化します。

### 3.4 性能測定 (ベンチマーク)
- 処理性能を確認するため、秒間リクエスト数 (RPS) や平均レスポンスタイムを測定するテストを導入し、`tox.ini` 等で定期的に実行することを提案します。

## 4. 結論

`ormsgpack` への移行により、RCEのリスクは劇的に減少しました。しかし、RPCの認可制御（ブラックリストの不備）には依然として深刻な欠陥があります。上記提案に基づき、認可ロジックの強化と、網羅的なテストスイートの構築を行うことを推奨します。
